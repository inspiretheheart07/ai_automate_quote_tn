name: Python CI

on:
  push:
  schedule:
    - cron: "30 1,3,5,7,9,11,13,15 * * *"

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GEMENI_KEY: ${{ secrets.GEMENI_KEY }}
      GEMENI_MODEL: ${{ secrets.GEMENI_MODEL }}
      ADJECTIVES: ${{ secrets.ADJECTIVES }}
      THEMES: ${{ secrets.THEMES }}
      LANGUAGE: ${{ secrets.LANGUAGE }}
      S3_ACCESS_KEY: ${{ secrets.S3_ACCESS_KEY }}
      S3_SECRETE_KEY: ${{ secrets.S3_SECRETE_KEY }}
      S3_ZONE: ${{ secrets.S3_ZONE }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}
      FB_VERSION: ${{ secrets.FB_VERSION }}
      FB_PAGE_ID: ${{ secrets.FB_PAGE_ID }}
      FB_PAGE_TOKEN: ${{ secrets.FB_PAGE_TOKEN }}
      INSTA_PAGE_ID: ${{ secrets.INSTA_PAGE_ID }}
      THREADS_VERSION: ${{ secrets.THREADS_VERSION }}
      S3_URL: ${{ secrets.S3_URL }}
      THREADS_PAGE_ID: ${{ secrets.THREADS_PAGE_ID }}
      THREADS_PAGE_TOKEN: ${{ secrets.THREADS_PAGE_TOKEN }}
      YT_JSON: ${{ secrets.YT_JSON }}
      DRIVE_LINK: ${{ secrets.DRIVE_LINK }}
      JSON_CLIENT_YT: ${{ secrets.JSON_CLIENT_YT }}
      JSON_OAUTH_YT: ${{ secrets.JSON_OAUTH_YT }}
      INSTA_PAGE_TOKEN: ${{ secrets.INSTA_PAGE_TOKEN }}


    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5

        with:
          python-version: '3.11.0'

      - name: Copy bg.png and font.ttf to working directory
        run: |
          cp assets/bg.png .
          cp assets/font_tn.ttf .
          cp assets/output_image.png .
      
      - name: Generate random number between 1 and 23
        id: random_number
        run: |
          RANDOM_NUM=$((1 + RANDOM % 23))
          echo "Random number is $RANDOM_NUM"
          echo "number=$RANDOM_NUM" >> $GITHUB_OUTPUT

      - name: Copy the randomly picked MP3
        run: |
          FILE="assets/music/${{ steps.random_number.outputs.number }}.mp3"
          echo "Copying $FILE to current directory as random.mp3"
          cp "$FILE" ./${{ steps.random_number.outputs.number }}.mp3

      - name: List files for verification
        run: ls -l

      - name: Set up apt
        run: |
            sudo apt update
            sudo apt install --fix-missing

      # - name: Install FFmpeg
      #   run: sudo apt-get install -y ffmpeg

      - name: Install FFmpeg
        uses: FedericoCarboni/setup-ffmpeg@v3
        id: setup-ffmpeg
        with:
        # Optional: Specify a version. Omit this line to use the latest.
         ffmpeg-version: "6.1.0"

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Download latest wheel from private repo
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          API_URL="https://api.github.com/repos/simplycodesmart/automate_quote_ai/dist"
          
          # Fetch JSON and extract the .whl download URL
          WHEEL_URL=$(curl -s -H "Authorization: token $GH_TOKEN" "$API_URL" \
                      | grep -oP '"download_url": "\K.*\.whl(?=")' | head -n 1)
          
          if [ -z "$WHEEL_URL" ]; then
            echo "Error: No .whl file found in dist/"
            exit 1
          fi
          
          echo "Downloading wheel from $WHEEL_URL"
          curl -L -H "Authorization: token $GH_TOKEN" -o ai_automate_quote.whl "$WHEEL_URL"
          
      - name: Install wheel
        run: pip install ai_automate_quote.whl

      # - name: Install private repo manually using GitHub token
      #   env:
      #     GH_TOKEN: ${{ secrets.GH_TOKEN }}
      #   run: |
      #     pip install git+https://$GH_TOKEN@github.com/simplycodesmart/automate_quote_ai.git

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Format and save client_secrets.json
        run: |
          python -c "
          import json
          import os
      
          # Load the client secrets from the GitHub secret (stored in JSON_OAUTH)
          client_secrets = os.getenv('JSON_OAUTH')
          
          # Debugging: Check if client_secrets is set
          if client_secrets is None:
              print('Error: JSON_OAUTH environment variable is not set.')
              exit(1)
      
          
      
          # Parse the secret into a JSON object
          client_secrets_dict = json.loads(client_secrets)
      
          # Re-encode the JSON object with double quotes
          with open('client_secrets.json', 'w') as f:
              json.dump(client_secrets_dict, f, indent=2)
      
          print('client_secrets.json successfully written')"
        env:
          JSON_OAUTH: ${{ secrets.JSON_CLIENT_YT }}  # Pass the secret here


      - name: Format and save oauth.json
        run: |
            python -c "
            import json
            import os
    
            # Load the client secrets from the GitHub secret (stored in JSON_OAUTH_MAIN)
            client_secrets = os.getenv('JSON_OAUTH_MAIN')
            
            # Debugging: Check if client_secrets is set
            
            
            if not client_secrets:
                exit('Error: JSON_OAUTH_MAIN is not set.')
    
            # Parse the secret into a JSON object
            client_secrets_dict = json.loads(client_secrets)
    
            # Re-encode the JSON object with double quotes
            with open('oauth.json', 'w') as f:
                json.dump(client_secrets_dict, f, indent=2)
    
            print('oauth.json successfully written')"
        env:
          JSON_OAUTH_MAIN: ${{ secrets.JSON_OAUTH_YT }}  # Pass the secret here

      - name: Run Process
        run: |
          echo "Running te_quote.py with random number ${{ steps.random_number.outputs.number }}"
          python te_quote.py "${{ steps.random_number.outputs.number }}"
